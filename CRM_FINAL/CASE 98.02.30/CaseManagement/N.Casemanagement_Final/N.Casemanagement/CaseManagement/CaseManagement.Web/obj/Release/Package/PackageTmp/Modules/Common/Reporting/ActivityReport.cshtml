<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="~/scripts/persian-date-0.1.8.js"></script>
    <script src="~/scripts/persian-datepicker-0.4.5.js"></script>
    <script src="~/scripts/jquery.selectboxit.js"></script>
    <link href="~/content/jquery.selectboxit.css" rel="stylesheet" />
    <link href="~/content/persian-datepicker.css" rel="stylesheet" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ActivityReport</title>

</head>


<body>

    <div class="col-md-12">
        <label style="width:5%; font-weight:normal; font-variant:normal;margin-right:5px;">استان : </label>
        <select id="Province" style="width: 130px; height: 25px; font-size: 10px;align-content:right;"></select>

        <!--<div class="select2-container editor flexify s-HardcodedValuesEditor s-BasicSamples-HardcodedValuesEditor" id="s2id_Serene1_BasicSamples_HardcodedValuesDialog0_SomeValue">
            <a href="javascript:void(0)" class="select2-choice select2-default" tabindex="-1">
                <span class="select2-chosen" id="select2-chosen-1">--select--</span><abbr class="select2-search-choice-close"></abbr>
                <span class="select2-arrow" role="presentation"><b role="presentation"></b></span>
            </a><label for="s2id_autogen1" class="select2-offscreen">Province</label>
            <input class="select2-focusser select2-offscreen" type="text" aria-haspopup="true" role="button" aria-labelledby="select2-chosen-1" id="s2id_autogen1">
         </div>
        <input type="text" class="editor flexify s-HardcodedValuesEditor s-BasicSamples-HardcodedValuesEditor select2-offscreen" id="Serene1_BasicSamples_HardcodedValuesDialog0_SomeValue" name="SomeValue" placeholder="--select--" tabindex="-1" title="Some Value">
        <div class="vx"></div>
        <div class="clear"></div>
       -->
            <label style="width:50px; font-weight:normal; font-variant:normal;margin-right:30px;">دوره : </label>
            <select id="Cycle" style="width:60px; height:25px;font-size:10px;"></select>

            <label style="width:90px; font-weight:normal; font-variant:normal;margin-right:30px;">جریان درآمدی : </label>
            <select id="IncomeFlow" style="width:110px; height:25px;font-size:10px;"></select>

            <label style="width: 150px; font-weight: normal; font-variant: normal; margin-right: 10px;"> تاریخ شناسایی نشتی : </label>

            <!--<label style="width:50px; font-weight:normal; font-variant:normal;margin-right:30px;">از  : </label>-->
            <input type="text" style="width:80px; height:30px;font-size:12px;" class="DateTimeFilter_Start" id="DateTimeFilter_Start" />

            <label style="width:10px; font-weight:normal; font-variant:normal;margin-right:10px;">-</label>
            <input type="text" style="width:80px; height:30px;font-size:12px;margin-bottom:5px;" class="DateTimeFilter_End" id="DateTimeFilter_End" />

        </div>
    <br /><br />
    <div class="col-md-12">
      
        <button type="button" id="search" class="btn btn-info btn-default" style="font-size:13px;margin-right:10px;float:left;font-weight:bold;color:white;">مشاهده گزارش</button>

        <!--<div class="tool-button print-preview-button"><div class="button-outer"><span class="button-inner">چاپ</span></div></div>-->
        <button type="button" id="print" class="btn btn-switch btn-default" style="font-size: 13px; margin-right: 10px; float: left; font-weight: bold;"><i class="fa fa-print" aria-hidden="true"></i> چاپ  </button>


        <!--   <div style="float:left;">-->
        <!-- <span class="input-group-btn">-->
        <!--</span>-->
        <!--  </div>-->

    </div>
 
    <div class="row">
        <div class="loader"></div>
        <div class="col-xs-12 table-responsive">

            <br />
            <table cellspacing="0" border="1" class="table table-striped" id="Province_Program_Table" style="font-family: Tahoma; font-size: 13px; border: 1px solid black; border-collapse: collapse;margin-bottom:0px; ">
                <thead style="background-color: #0090D9; color: #eee; font-weight: 600;">
                    <tr>
                        <th style="text-align: center; border: 1px solid black;">کد فعالیت</th>
                        <th style="text-align: center; border: 1px solid black;">تعداد فعالیت</th>
                        <th style="text-align: center; border: 1px solid black;">تعداد فعالیت مطلوب در سال</th>
                        <th style="text-align: center; border: 1px solid black;">مبلغ سیکل</th>
                        <th style="text-align: center; border: 1px solid black;">مبلغ معوق</th>
                        <th style="text-align: center; border: 1px solid black;">نشتی شناسایی شده کل</th>
                        <th style="text-align: center; border: 1px solid black;">نشتی قابل وصول</th>
                        <th style="text-align: center; border: 1px solid black;">مبلغ مصوب</th>

                    </tr>
                </thead>
                <tbody style="text-align: center; line-height: 1; "></tbody>
            </table>
        </div>
        <!-- /.col -->
    </div>

</body>
</html>
<script type="text/javascript">
    $(function () {
        $("#DateTimeFilter_Start").datepicker();
        $("#DateTimeFilter_End").datepicker();
    });

  

    var url = "http://" + window.location.hostname + ":" + window.location.port + "/Services/Case/Activity/List";
    // alert("URL : " + url);
    //var ProvID = '';
    var Activity = new Array(94);
    var ActivityRepeatTermId = new Array(94);

    $.ajaxSetup({ async: false });
    $.getJSON(url, function (data) {

        for (var i = 0; i < data.TotalCount; i++) {
            Activity[data.Entities[i].Id] = data.Entities[i].Code;

            ActivityRepeatTermId[data.Entities[i].Id] = data.Entities[i].RepeatTermId;
            //console.log(data.Entities[i].Name);
        }
    });

    var url = "http://" + window.location.hostname + ":" + window.location.port + "/Services/Case/RepeatTerm/List";
    // alert("URL : " + url);
    //var ProvID = '';
    var RepeatTerm = new Array(8);

    $.ajaxSetup({ async: false });
    $.getJSON(url, function (data) {

        for (var i = 0; i < data.TotalCount; i++) {
            RepeatTerm[data.Entities[i].Id] = data.Entities[i].RequiredYearRepeatCount;
            //console.log(data.Entities[i].Name);
        }
    });



    //console.log(IncomeFlow.length);
    var url = "http://" + window.location.hostname + ":" + window.location.port + "/Services/Case/Cycle/List";
    // alert("URL : " + url);

    var CycleCombo = document.getElementById("Cycle");
    //FIXME
    var SecondOption = document.createElement("option");
    SecondOption.text = "";
    SecondOption.value = "0";
    CycleCombo.add(SecondOption, null);

    //FIXME
    $.ajaxSetup({ async: false });
    $.getJSON(url, function (data) {

        for (var i = 0; i < data.TotalCount; i++) {

            var option = document.createElement("option");
            option.text = data.Entities[i].CycleName;
            option.value = data.Entities[i].Id;

            CycleCombo.add(option, null); //Standard

        }
    });


    var url = "http://" + window.location.hostname + ":" + window.location.port + "/Services/Case/IncomeFlow/List";
    // alert("URL : " + url);

    var IncomeFlowCombo = document.getElementById("IncomeFlow");
    //FIXME
    var FirstOption = document.createElement("option");
    FirstOption.text = "";
    FirstOption.value = "0";
    IncomeFlowCombo.add(FirstOption, null);

    $.ajaxSetup({ async: false });
    $.getJSON(url, function (data) {

        for (var i = 0; i < data.TotalCount; i++) {

            var option = document.createElement("option");
            option.text = data.Entities[i].Name;
            option.value = data.Entities[i].Id;

            IncomeFlowCombo.add(option, null); //Standard 

        }
    });


    //  console.log(document.getElementById("DateTimeFilter_Start").value);
    //   console.log(document.getElementById("DateTimeFilter_End").value);


    var url = "http://" + window.location.hostname + ":" + window.location.port + "/Services/Case/Province/List";
    var ProvinceCombo = document.getElementById("Province");
    //FIXME
    var ProvinceOption = document.createElement("option");
    ProvinceOption.text = "";
    ProvinceOption.value = "0";
    ProvinceCombo.add(ProvinceOption, null);

    //FIXME
    $.ajaxSetup({ async: false });
    $.getJSON(url, function (data) {

        for (var i = 0; i < data.TotalCount; i++) {

            var option = document.createElement("option");
            option.text = data.Entities[i].Name;
            option.value = data.Entities[i].Id;

            ProvinceCombo.add(option, null); //Standard

        }
    });

    function CostSeperator(value) {
        if (value != null) {
            var persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            value = value.toString();
            value = value.replace(/\,/g, '');
            var objRegex = new RegExp('(-?[0-9]+)([0-9]{3})');
            while (objRegex.test(value))
                value = value.replace(objRegex, '$1,$2');

            value = value.replace(/[0-9]/g, function (w) { return persianNumbers[+w] });
        }
        return value;
    }

    function PersiaNumber(value) {
        var arabicNumbers = ['۰', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];

        var chars = value.split('');

        for (var i = 0; i < chars.length; i++) {
            if (/\d/.test(chars[i])) {
                chars[i] = arabicNumbers[chars[i]];
            }
        }

        return chars.join('');

    }
   

    $('#print').click(function () {


        var select = document.getElementById("Province");

        var selectedProvince = select.options[select.selectedIndex].value;

        var select1 = document.getElementById("Cycle");

        var selectedCycle = select1.options[select1.selectedIndex].value;

        var select2 = document.getElementById("IncomeFlow");

        var selectedIncomeFlow = select2.options[select2.selectedIndex].value;

        window.location.href = "../StimulReport4/ActivityReportPrint?IncomeFlowID=" + selectedIncomeFlow + "&cycleID=" + selectedCycle + "&ProvinceID=" + selectedProvince +
            "&fromDate=" + document.getElementById("DateTimeFilter_Start").value + "&toDate=" + document.getElementById("DateTimeFilter_End").value;


    });



    $('#search').click(function () {

    
        var select = document.getElementById("Province");

        var selectedProvince = select.options[select.selectedIndex].value;

        var select1 = document.getElementById("Cycle");

        var selectedCycle = select1.options[select1.selectedIndex].value;

        var select2 = document.getElementById("IncomeFlow");

        var selectedIncomeFlow = select2.options[select2.selectedIndex].value;


        var tableRef = document.getElementById('Province_Program_Table').getElementsByTagName('tbody')[0];
        tableRef.innerHTML = " ";

        //  console.log(selectedIncomeFlow);
        //  console.log(selectedCycle);
        //  console.log(document.getElementById("DateTimeFilter_Start").value);
        //  console.log(document.getElementById("DateTimeFilter_End").value);


        var url1 = "GetActivityReportInfo?incomFlowID=" + selectedIncomeFlow + "&cycleID=" + selectedCycle + "&ProvinceID=" + selectedProvince + "&fromDate=" +
            document.getElementById("DateTimeFilter_Start").value + "&toDate=" + document.getElementById("DateTimeFilter_End").value;
        

$(document)
 .ajaxStart(function () {
     $.blockUI({
         message: '<b> در حال گزارشگیری ...</b>',
         css: {
             border: 'none',
             padding: '15px',
             backgroundColor: '#000',
             '-webkit-border-radius': '10px',
             '-moz-border-radius': '10px',
             opacity: .5,
             color: '#fff',
             width: '200px'
         }
     });
 })
 .ajaxStop(function () {
     $.unblockUI();
 });
        $.ajax({
            type: "GET",
            async: true,
            // data: obj,
             //beforeSend: loading ,
            url: url1,
            success: function (data) {

                var Total_ActivityCount = 0;
                var Total_RequiredYearRepeatCount = 0;
                var Total_CycleCost = 0;
                var Total_DelayedCost = 0;
                var Total_TotalLeakage = 0;
                var Total_RecoverableLeakage = 0;
                var Total_Recovered = 0;


               
                for (var ActivityCount = 1 ; ActivityCount < Activity.length ; ActivityCount++) {
                    var flag = false;
                    var ArrayIndex = -1;
                    //console.log(Activity[ActivityCount]);
                    for (var counter = 0; counter < data.length; counter++) {
                        if (data[counter].ActivityID == ActivityCount) {
                            flag = true;
                            ArrayIndex = counter;
                        }
                        //console.log(data[counter].ProvinceID);
                    }

                    var newRow = tableRef.insertRow(tableRef.rows.length);

                    // Insert a cell in the row at index 0
                    if (flag) {
                        //console.log("true");
                        var newCell = newRow.insertCell(0);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode(PersiaNumber(Activity[ActivityCount]));
                        newCell.appendChild(newText);


                        var newCell = newRow.insertCell(1);
                        newCell.style.border = ' 1px solid black';
                        if (data[ArrayIndex].ActivityCount) {
                            var newText = document.createTextNode(PersiaNumber(data[ArrayIndex].ActivityCount.toString()));
                            newCell.appendChild(newText);
                            Total_ActivityCount += data[ArrayIndex].ActivityCount;
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }


                        var newCell = newRow.insertCell(2);
                        newCell.style.border = ' 1px solid black';
                        if (RepeatTerm[ActivityRepeatTermId[ActivityCount]]) {
                           // console.log(ActivityRepeatTermId[ActivityCount]);
                           // console.log(RepeatTerm[ActivityRepeatTermId[ActivityCount]]);
                            var newText = document.createTextNode(PersiaNumber(RepeatTerm[ActivityRepeatTermId[ActivityCount]].toString()));
                            newCell.appendChild(newText);
                            Total_RequiredYearRepeatCount += RepeatTerm[ActivityRepeatTermId[ActivityCount]];
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }

                        var newCell = newRow.insertCell(3);
                        newCell.style.border = ' 1px solid black';
                        if (data[ArrayIndex].SumCycleCost) {
                            var newText = document.createTextNode(CostSeperator(data[ArrayIndex].SumCycleCost));
                            newCell.appendChild(newText);
                            Total_CycleCost += data[ArrayIndex].SumCycleCost;
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }


                        var newCell = newRow.insertCell(4);
                        newCell.style.border = ' 1px solid black';
                        if (data[ArrayIndex].SumDelayedCost) {
                            var newText = document.createTextNode(CostSeperator(data[ArrayIndex].SumDelayedCost));
                            newCell.appendChild(newText);
                            Total_DelayedCost += data[ArrayIndex].SumDelayedCost;
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }


                        var newCell = newRow.insertCell(5);
                        newCell.style.border = ' 1px solid black';
                        if (data[ArrayIndex].SumTotalLeakage) {
                            var newText = document.createTextNode(CostSeperator(data[ArrayIndex].SumTotalLeakage));
                            newCell.appendChild(newText);
                            Total_TotalLeakage += data[ArrayIndex].SumTotalLeakage;
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }


                        var newCell = newRow.insertCell(6);
                        newCell.style.border = ' 1px solid black';
                        if (data[ArrayIndex].SumRecoverableLeakage) {
                            var newText = document.createTextNode(CostSeperator(data[ArrayIndex].SumRecoverableLeakage));
                            newCell.appendChild(newText);
                            Total_RecoverableLeakage += data[ArrayIndex].SumRecoverableLeakage;
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }


                        var newCell = newRow.insertCell(7);
                        newCell.style.border = ' 1px solid black';
                        if (data[ArrayIndex].SumRecovered) {
                            var newText = document.createTextNode(CostSeperator(data[ArrayIndex].SumRecovered));
                            newCell.appendChild(newText);
                            Total_Recovered += data[ArrayIndex].SumRecovered;
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }

                    } else {
                        // console.log("false");

                        var newCell = newRow.insertCell(0);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode(PersiaNumber(Activity[ActivityCount]));
                        newCell.appendChild(newText);


                        var newCell = newRow.insertCell(1);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode("");
                        newCell.appendChild(newText);
                        
                        var newCell = newRow.insertCell(2);
                        newCell.style.border = ' 1px solid black';
                        if (RepeatTerm[ActivityRepeatTermId[ActivityCount]]) {
                            var newText = document.createTextNode(PersiaNumber(RepeatTerm[ActivityRepeatTermId[ActivityCount]].toString()));
                            Total_RequiredYearRepeatCount += RepeatTerm[ActivityRepeatTermId[ActivityCount]];
                            newCell.appendChild(newText);
                        } else {
                            var newText = document.createTextNode("۰");
                            newCell.appendChild(newText);
                        }

                        var newCell = newRow.insertCell(3);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode("");
                        newCell.appendChild(newText);

                        var newCell = newRow.insertCell(4);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode("");
                        newCell.appendChild(newText);

                        var newCell = newRow.insertCell(5);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode("");
                        newCell.appendChild(newText);

                        var newCell = newRow.insertCell(6);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode("");
                        newCell.appendChild(newText);

                        var newCell = newRow.insertCell(7);
                        newCell.style.border = ' 1px solid black';
                        var newText = document.createTextNode("");
                        newCell.appendChild(newText);
                         // $.unblockUI();

                    }
                }
                
                var newRow = tableRef.insertRow(tableRef.rows.length);

                var newCell = newRow.insertCell(0);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                // Append a text node to the cell
                var newText = document.createTextNode('مجموع');
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(1);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(PersiaNumber(Total_ActivityCount.toString()));
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(2);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(PersiaNumber(Total_RequiredYearRepeatCount.toString()));//PersiaNumber(Total_RequiredYearRepeatCount.toString()));
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(3);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(CostSeperator(Total_CycleCost));
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(4);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(CostSeperator(Total_DelayedCost));
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(5);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(CostSeperator(Total_TotalLeakage));
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(6);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(CostSeperator(Total_RecoverableLeakage));
                newCell.appendChild(newText);

                var newCell = newRow.insertCell(7);
                newCell.style.border = ' 1px solid black';
                newCell.style = 'font-weight: bold;font-size:14px';
                var newText = document.createTextNode(CostSeperator(Total_Recovered));
                newCell.appendChild(newText);


               // $.unblockUI();

            }
           
        });

    });
   


</script>