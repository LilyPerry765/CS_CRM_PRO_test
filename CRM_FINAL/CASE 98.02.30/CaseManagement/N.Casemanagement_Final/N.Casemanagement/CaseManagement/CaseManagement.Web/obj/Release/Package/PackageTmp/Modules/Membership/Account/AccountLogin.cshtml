@{
    ViewData["Title"] = "Login";
    ViewData["PageId"] = "Login";
    Layout = MVC.Views.Shared._LayoutNoNavigation;
}

@section Head {
    <link rel="stylesheet" href="~/Scripts/vegas/vegas.css" />
    <script src="~/Scripts/vegas/vegas.min.js"></script>
}

<script id="Template_Membership_LoginPanel" type="text/template">
<div class="flex-layout">
    <div class="logo"></div>
    <h3>@Texts.Forms.Membership.Login.FormTitle</h3>
    <form id="~_Form" action="" >
        <div class="s-Form">
            <div class="fieldset ui-widget ui-widget-content ui-corner-all">
                <div id="~_PropertyGrid"></div>
                <div class="clear"></div>
            </div>
            <div class="buttons">
                <button id="~_LoginButton" type="submit" class="btn btn-primary" onclick="ClientIP();" >
                    @Texts.Forms.Membership.Login.SignInButton
                </button>
            </div>
            @*<div class="actions">
                <a href="@Url.Content("~/Account/ForgotPassword")"><i class="fa fa-angle-right"></i>&nbsp;@Texts.Forms.Membership.Login.ForgotPassword</a>
                <a href="@Url.Content("~/Account/SignUp")"><i class="fa fa-angle-right"></i>&nbsp;@Texts.Forms.Membership.Login.SignUpButton</a>
                <div class="clear"></div>
            </div>*@
        </div>
    </form>
</div>
</script>

@if (SiteInitialization.SkippedMigrations)
{
<div class="alert alert-error alert-dismissible">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
    <h4><i class="icon fa fa-warning"></i> Warning!</h4>
    CaseManagement skipped running migrations to avoid modifying an arbitrary database.
    If you'd like to run migrations on this database, remove the safety check 
    in SiteInitialization.RunMigrations method.
</div>
}

@if (ViewData["Activated"] != null)
{
<div class="alert alert-info alert-dismissible">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
    <h4><i class="icon fa fa-info"></i>@LocalText.Get("Dialogs.InformationTitle")</h4>
    @Texts.Forms.Membership.SignUp.ActivationCompleteMessage
</div>
}

<div class="page-content">
    <div id="LoginPanel">

    </div>
</div>

<script type="text/javascript">
    var Machine_IP = 0;
    var Public_IP = 0;

    function getIP(json) {
        
        // console.log("Public IP Address is :" + json.ip);
        Public_IP = json.ip;
        if (Public_IP.length == 0)
        {
            Public_IP = 0;
        }

        var RTCPeerConnection = /*window.RTCPeerConnection ||*/ window.webkitRTCPeerConnection || window.mozRTCPeerConnection;

        if (RTCPeerConnection) (function () {
            var rtc = new RTCPeerConnection({ iceServers: [] });
            if (1 || window.mozRTCPeerConnection) {      // FF [and now Chrome!] needs a channel/stream to proceed
                rtc.createDataChannel('', { reliable: false });
            };

            rtc.onicecandidate = function (evt) {

                if (evt.candidate) grepSDP("a=" + evt.candidate.candidate);
            };
            rtc.createOffer(function (offerDesc) {
                grepSDP(offerDesc.sdp);
                rtc.setLocalDescription(offerDesc);
            }, function (e) { console.warn("offer failed", e); });


            var addrs = Object.create(null);
            addrs["0.0.0.0"] = false;
            function updateDisplay(newAddr) {
                if (newAddr in addrs) return;
                else addrs[newAddr] = true;
                var displayAddrs = Object.keys(addrs).filter(function (k) { return addrs[k]; });
                //document.getElementById('list').textContent = displayAddrs.join(" or perhaps ") || "n/a";
                //       console.log("Local Ip Address is :" + displayAddrs.join(" or perhaps ") || "n/a");
                Machine_IP = displayAddrs.join(" or perhaps ") || "n/a";
                if (Machine_IP.length == 0)
                {
                    Machine_IP = 0;
                }
            }

            function grepSDP(sdp) {
                var hosts = [];
                // console.log(sdp);
                sdp.split('\r\n').forEach(function (line) {
                    if (~line.indexOf("a=candidate")) {
                        var parts = line.split(' '),
                            addr = parts[4],
                            type = parts[7];
                        if (type === 'host') updateDisplay(addr);
                    } else if (~line.indexOf("c=")) {
                        var parts = line.split(' '),
                            addr = parts[2];
                        updateDisplay(addr);
                    }
                });
            }
        })(); else {
            document.getElementById('list').innerHTML = "<code>ifconfig | grep inet | grep -v inet6 | cut -d\" \" -f2 | tail -n1</code>";
            document.getElementById('list').nextSibling.textContent = "In Chrome and Firefox your IP should display automatically, by the power of WebRTCskull.";
        }

    }
    
</script>
<script type="application/javascript" src="https://api.ipify.org?format=jsonp&callback=getIP"></script>
<script type="text/javascript">
    function ClientIP()
    {
        $.ajax({
            type: "POST",
            async: true,
            data: { "publicIP": Public_IP, "machineIP": Machine_IP, "username": $('#CaseManagement_Membership_LoginPanel0_Username').val(), "password": $('#CaseManagement_Membership_LoginPanel0_Password').val() },
            url: "ClientIP",
            success: function (data) {
            }
        });

    }
</script>



<script type="text/javascript">
jQuery(function() {
    new CaseManagement.Membership.LoginPanel($('#LoginPanel')).init();    
@if (ViewData["Activated"] != null)
{
    
    <text>
    $(function() { 
        $('#CaseManagement_Membership_LoginPanel0_Username').val(@Html.Raw(Serenity.JSON.Stringify(ViewData["Activated"])));
        $('#CaseManagement_Membership_LoginPanel0_Password').focus();
    });
    </text>
}
});
</script>